<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sefion Security - Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: white;
        }
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 300px;
            height: 100vh;
            background: linear-gradient(180deg, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.8) 100%);
            backdrop-filter: blur(15px);
            padding: 30px 25px;
            overflow-y: auto;
            border-right: 2px solid rgba(48, 191, 255, 0.2);
            box-shadow: 5px 0 20px rgba(0,0,0,0.3);
        }
        .main {
            margin-left: 300px;
            padding: 30px;
            min-height: 100vh;
        }
        .user-info {
            display: flex;
            align-items: center;
            padding: 25px;
            background: linear-gradient(135deg, rgba(48, 191, 255, 0.15) 0%, rgba(48, 191, 255, 0.05) 100%);
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(48, 191, 255, 0.3);
            box-shadow: 0 10px 25px rgba(48, 191, 255, 0.1);
        }
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 20px;
            border: 3px solid rgba(48, 191, 255, 0.5);
            box-shadow: 0 0 20px rgba(48, 191, 255, 0.3);
        }
        .user-details h3 {
            margin-bottom: 8px;
            font-size: 1.3em;
            color: #30BFFF;
        }
        .user-details p {
            opacity: 0.8;
            font-size: 0.9em;
        }
        .sidebar-section {
            margin-bottom: 35px;
        }
        .sidebar-section h4 {
            color: #30BFFF;
            margin-bottom: 20px;
            font-size: 1.2em;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 700;
        }
        .server-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            margin: 15px 0;
            padding: 25px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.4s ease;
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }
        .server-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(48, 191, 255, 0.1), transparent);
            transition: left 0.5s;
        }
        .server-card:hover::before {
            left: 100%;
        }
        .server-card:hover {
            background: linear-gradient(135deg, rgba(48, 191, 255, 0.2) 0%, rgba(48, 191, 255, 0.1) 100%);
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(48, 191, 255, 0.2);
            border-color: rgba(48, 191, 255, 0.4);
        }
        .server-name {
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 8px;
            color: white;
        }
        .server-id {
            font-size: 0.85em;
            opacity: 0.7;
            margin-bottom: 10px;
        }
        .server-status {
            font-size: 0.9em;
            font-weight: 600;
        }
        .nav-button {
            display: block;
            width: 100%;
            padding: 18px 20px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            color: white;
            text-decoration: none;
            border-radius: 15px;
            margin: 12px 0;
            transition: all 0.4s ease;
            text-align: left;
            border: 1px solid rgba(255,255,255,0.1);
            font-weight: 600;
            font-size: 1em;
        }
        .nav-button:hover {
            background: linear-gradient(135deg, rgba(48, 191, 255, 0.3) 0%, rgba(48, 191, 255, 0.1) 100%);
            border-color: rgba(48, 191, 255, 0.5);
            transform: translateX(10px);
            box-shadow: 0 10px 25px rgba(48, 191, 255, 0.2);
        }
        .nav-button.danger {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.2) 0%, rgba(220, 53, 69, 0.1) 100%);
            border-color: rgba(220, 53, 69, 0.3);
        }
        .nav-button.danger:hover {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.4) 0%, rgba(220, 53, 69, 0.2) 100%);
            border-color: rgba(220, 53, 69, 0.6);
        }
        .header {
            background: linear-gradient(135deg, rgba(48, 191, 255, 0.15) 0%, rgba(48, 191, 255, 0.05) 100%);
            padding: 40px;
            margin-bottom: 30px;
            border-radius: 25px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(48, 191, 255, 0.2);
            box-shadow: 0 15px 35px rgba(48, 191, 255, 0.1);
        }
        .header h1 {
            font-size: 3em;
            margin-bottom: 15px;
            background: linear-gradient(45deg, #30BFFF, white);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 900;
        }
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            line-height: 1.6;
        }
        .config-section {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            margin: 30px 0;
            padding: 35px;
            border-radius: 25px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.4s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .config-section:hover {
            border-color: rgba(48, 191, 255, 0.3);
            box-shadow: 0 15px 40px rgba(48, 191, 255, 0.1);
        }
        .config-section h2 {
            color: #30BFFF;
            margin-bottom: 25px;
            font-size: 2em;
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 700;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 80px;
            height: 40px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, #333, #555);
            transition: .4s;
            border-radius: 40px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 32px;
            width: 32px;
            left: 4px;
            bottom: 4px;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        input:checked + .slider {
            background: linear-gradient(45deg, #30BFFF, #0ea5e9);
            box-shadow: 0 0 20px rgba(48, 191, 255, 0.4);
        }
        input:checked + .slider:before {
            transform: translateX(40px);
        }
        .btn {
            background: linear-gradient(45deg, #30BFFF, #0ea5e9);
            color: white;
            padding: 15px 35px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            margin: 12px 8px;
            transition: all 0.4s ease;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            font-size: 1em;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .btn:hover::before {
            left: 100%;
        }
        .btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(48, 191, 255, 0.4);
        }
        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }
        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
        }
        .btn-primary {
            background: linear-gradient(45deg, #30BFFF, #0ea5e9);
        }
        .form-group {
            margin: 25px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 12px;
            font-weight: bold;
            color: #30BFFF;
            font-size: 1.1em;
        }
        .form-control, .form-select {
            width: 100%;
            padding: 18px;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            background: rgba(255,255,255,0.05);
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        .form-control:focus, .form-select:focus {
            outline: none;
            border-color: #30BFFF;
            box-shadow: 0 0 25px rgba(48, 191, 255, 0.3);
            background: rgba(255,255,255,0.1);
        }
        .form-control::placeholder {
            color: rgba(255,255,255,0.6);
        }
        .form-select option {
            background: #1a1a2e;
            color: white;
        }
        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }
        .permission-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.4s ease;
            backdrop-filter: blur(10px);
        }
        .permission-item:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(48, 191, 255, 0.4);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(48, 191, 255, 0.1);
        }
        .protection-item {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 30px;
            margin-bottom: 25px;
            transition: all 0.4s ease;
            backdrop-filter: blur(10px);
        }
        .protection-item:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(48, 191, 255, 0.4);
            box-shadow: 0 15px 35px rgba(48, 191, 255, 0.1);
        }
        .protection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .protection-title {
            font-size: 1.3em;
            font-weight: bold;
            color: white;
        }
        .protection-settings {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .protection-settings.active {
            display: grid;
        }
        .setting-input {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .setting-input label {
            font-size: 1em;
            color: #30BFFF;
            font-weight: 600;
        }
        .setting-input input, .setting-input select {
            padding: 12px 15px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .setting-input input:focus, .setting-input select:focus {
            border-color: #30BFFF;
            box-shadow: 0 0 15px rgba(48, 191, 255, 0.2);
        }
        .user-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            padding: 25px;
            margin: 20px 0;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.4s ease;
            backdrop-filter: blur(10px);
        }
        .user-card:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(48, 191, 255, 0.1);
        }
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin: 35px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, rgba(48, 191, 255, 0.15) 0%, rgba(48, 191, 255, 0.05) 100%);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            border: 1px solid rgba(48, 191, 255, 0.2);
            transition: all 0.4s ease;
            backdrop-filter: blur(10px);
        }
        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(48, 191, 255, 0.2);
        }
        .stat-card h3 {
            font-size: 2.5em;
            color: #30BFFF;
            margin-bottom: 15px;
            font-weight: 900;
        }
        .stat-card p {
            font-size: 1.1em;
            opacity: 0.9;
            font-weight: 600;
        }
        .loading {
            display: inline-block;
            width: 25px;
            height: 25px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #30BFFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 20px 25px;
            border-radius: 15px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            transition: all 0.4s ease;
            transform: translateX(100%);
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .notification.success {
            background: linear-gradient(45deg, #28a745, #20c997);
        }
        .notification.error {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }
        .notification.info {
            background: linear-gradient(45deg, #30BFFF, #0ea5e9);
        }
        .copyright {
            position: fixed;
            bottom: 25px;
            right: 25px;
            font-size: 0.9em;
            opacity: 0.6;
            z-index: 1000;
        }
        .section-navigation {
            display: none;
            margin-bottom: 30px;
        }
        .section-navigation.active {
            display: block;
        }
        .section-nav-button {
            display: inline-block;
            padding: 15px 25px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            color: white;
            text-decoration: none;
            border-radius: 15px;
            margin: 8px;
            transition: all 0.4s ease;
            border: 1px solid rgba(255,255,255,0.1);
            font-weight: 600;
            cursor: pointer;
        }
        .section-nav-button:hover, .section-nav-button.active {
            background: linear-gradient(135deg, rgba(48, 191, 255, 0.3) 0%, rgba(48, 191, 255, 0.1) 100%);
            border-color: rgba(48, 191, 255, 0.5);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(48, 191, 255, 0.2);
        }
        @media (max-width: 768px) {
            .sidebar { 
                position: relative; 
                width: 100%; 
                height: auto; 
            }
            .main { 
                margin-left: 0; 
                padding: 20px; 
            }
            .permissions-grid { 
                grid-template-columns: 1fr; 
            }
            .protection-settings {
                grid-template-columns: 1fr;
            }
            .stats-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="user-info">
            <img src="" alt="Avatar" class="user-avatar" id="user-avatar">
            <div class="user-details">
                <h3 id="username">Loading...</h3>
                <p id="user-id">ID: ---</p>
            </div>
        </div>
        
        <div class="sidebar-section">
            <h4>üè† Navigation</h4>
            <a href="#" class="nav-button" onclick="showServerList()">üõ°Ô∏è My Servers</a>
            <a href="/" class="nav-button">üåê Home</a>
            <a href="/logout" class="nav-button danger">üö™ Logout</a>
        </div>
        
        <div class="section-navigation" id="section-navigation">
            <h4>‚öôÔ∏è Configuration</h4>
            <div class="section-nav-button" onclick="showPermissionsSection()">üîê Permissions</div>
            <div class="section-nav-button" onclick="showVerificationSection()">‚úÖ Verification</div>
            <div class="section-nav-button" onclick="showProtectionSection()">üõ°Ô∏è Anti-Nuke</div>
        </div>
    </div>

    <div class="main">
        <div id="server-list">
            <div class="header">
                <h1>Sefion Security Dashboard</h1>
                <p>Welcome to your control dashboard. Select a server to start configuring advanced protections and security features.</p>
            </div>
            
            <div class="stats-row">
                <div class="stat-card">
                    <h3 id="total-manageable-servers">0</h3>
                    <p>Manageable Servers</p>
                </div>
                <div class="stat-card">
                    <h3>24/7</h3>
                    <p>Active Protection</p>
                </div>
                <div class="stat-card">
                    <h3>Free</h3>
                    <p>Current Plan</p>
                </div>
            </div>
            
            <div class="config-section">
                <h2>üõ°Ô∏è Your Servers</h2>
                <div class="permissions-grid" id="main-server-list">
                    <div class="loading"></div>
                </div>
            </div>
        </div>

        <div id="server-config" style="display: none;">
            <div class="header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 id="current-server">Server Configuration</h1>
                        <p id="server-description">Configure protections and settings for your server</p>
                    </div>
                    <button class="btn" onclick="showServerList()">‚Üê Back to Servers</button>
                </div>
            </div>

            <div id="permissions-section" class="config-section" style="display: none;">
                <h2>üîê Permissions</h2>
                <p>Manage who can use bot functions</p>
                <div class="permissions-grid">
                    <div class="form-group">
                        <label>Add Moderator</label>
                        <div style="display: flex; gap: 15px;">
                            <input type="text" class="form-control" id="new-moderator-id" placeholder="Discord User ID" style="flex: 1;">
                            <button class="btn btn-success" onclick="addModerator()">‚ûï Add</button>
                        </div>
                    </div>
                </div>
                <div id="moderators-list"></div>
            </div>

            <div id="verification-section" class="config-section" style="display: none;">
                <h2>üîí Verification System</h2>
                <p>Configure verification system for new members</p>
                <div class="permission-item" style="margin-bottom: 25px;">
                    <div>
                        <strong>Verification Enabled</strong>
                        <p>Enable/disable verification system</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="verification-enabled" onchange="toggleVerification(this)">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="permissions-grid">
                    <div class="form-group">
                        <label>üìù Verification Channel</label>
                        <select class="form-select" id="verification-channel">
                            <option value="">Select a channel</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üé≠ Verified Role</label>
                        <select class="form-select" id="verification-role">
                            <option value="">Select a role</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üí¨ Custom Message</label>
                        <input type="text" class="form-control" id="verification-message" placeholder="Welcome message for verification">
                    </div>
                    <div class="form-group">
                        <label>üé® Embed Color</label>
                        <input type="color" class="form-control" id="embed-color" value="#30BFFF">
                    </div>
                    <div class="permission-item">
                        <div>
                            <strong>üî§ Captcha Enabled</strong>
                            <p>Requires captcha completion</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="captcha-enabled" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <button class="btn btn-success" onclick="saveVerification()">üíæ Save Verification Configuration</button>
            </div>

            <div id="protection-section" class="config-section" style="display: none;">
                <h2>üõ°Ô∏è Anti-Nuke Protections</h2>
                <p>Configure protections and punishment systems</p>
                
                <div id="protection-items"></div>

                <div class="permissions-grid" style="margin-top: 35px;">
                    <div class="form-group">
                        <label>üö´ Ban/Kick Log</label>
                        <select class="form-select" id="banLog">
                            <option value="">Select channel for ban/kick logs</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üé≠ Role Log</label>
                        <select class="form-select" id="roleLog">
                            <option value="">Select channel for role logs</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üìù Channel Log</label>
                        <select class="form-select" id="channelLog">
                            <option value="">Select channel for channel logs</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üõ°Ô∏è Security Log</label>
                        <select class="form-select" id="securityLog">
                            <option value="">Select channel for security logs</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üìä General Log</label>
                        <select class="form-select" id="generalLog">
                            <option value="">Select channel for general logs</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üì® Message Log</label>
                        <select class="form-select" id="messageLog">
                            <option value="">Select channel for message logs</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üì• Join/Leave Log</label>
                        <select class="form-select" id="joinLeaveLog">
                            <option value="">Select channel for join/leave logs</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-success" onclick="saveLogChannels()">üíæ Save Log Channels</button>
            </div>

            <div class="config-section">
                <h2>‚≠ê Plus/Premium Features</h2>
                <p>Unlock advanced features with upgrade</p>
                <div class="permissions-grid">
                    <div class="permission-item" style="opacity: 0.6;">
                        <div>
                            <strong>üö´ Anti-Spam <span style="color: #30BFFF;">[PLUS]</span></strong>
                            <p>Automatically detect and block spam</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" disabled>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="permission-item" style="opacity: 0.6;">
                        <div>
                            <strong>üòÄ Anti-Emoji Create <span style="color: #30BFFF;">[PLUS]</span></strong>
                            <p>Block unauthorized emoji creation</p>
                        </div>
                                                <label class="toggle-switch">
                            <input type="checkbox" disabled>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="permission-item" style="opacity: 0.6;">
                        <div>
                            <strong>üëª Anti-Ghost Ping <span style="color: #30BFFF;">[PLUS]</span></strong>
                            <p>Detect quickly deleted mentions</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" disabled>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="permission-item" style="opacity: 0.6;">
                        <div>
                            <strong>‚öîÔ∏è Anti-Raid <span style="color: #e74c3c;">[PREMIUM]</span></strong>
                            <p>Advanced protection against massive raids</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" disabled>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 25px;">
                    <button class="btn btn-success">‚≠ê Upgrade to Plus - ‚Ç¨4.99/month</button>
                </div>
            </div>
        </div>
    </div>

    <div class="copyright">
        ¬© 2025 Sefion Security - All rights reserved
    </div>

    <script>
        let currentGuildId = null;
        let userGuilds = [];
        let guildChannels = [];
        let guildRoles = [];
        let guildSettings = {};
        const BOT_CLIENT_ID = '1076256814208921722';

        const protectionConfigs = {
            antiBan: { 
                icon: 'üö´', 
                name: 'Anti Ban', 
                description: 'Prevents unauthorized bans',
                defaultLimit: 1,
                defaultPunishment: 'ban',
                defaultTimeout: 10
            },
            antiKick: { 
                icon: 'üë¢', 
                name: 'Anti Kick', 
                description: 'Prevents unauthorized kicks',
                defaultLimit: 3,
                defaultPunishment: 'kick',
                defaultTimeout: 10
            },
            antiRoleCreate: { 
                icon: 'üé≠', 
                name: 'Anti Role Create', 
                description: 'Blocks unauthorized role creation',
                defaultLimit: 2,
                defaultPunishment: 'ban',
                defaultTimeout: 30
            },
            antiRoleDelete: { 
                icon: 'üóëÔ∏è', 
                name: 'Anti Role Delete', 
                description: 'Prevents role deletion',
                defaultLimit: 2,
                defaultPunishment: 'ban',
                defaultTimeout: 30
            },
            antiChannelCreate: { 
                icon: 'üìù', 
                name: 'Anti Channel Create', 
                description: 'Blocks unauthorized channel creation',
                defaultLimit: 3,
                defaultPunishment: 'ban',
                defaultTimeout: 30
            },
            antiChannelDelete: { 
                icon: 'üóÇÔ∏è', 
                name: 'Anti Channel Delete', 
                description: 'Prevents channel deletion',
                defaultLimit: 3,
                defaultPunishment: 'ban',
                defaultTimeout: 30
            },
            antiMention: { 
                icon: 'üì¢', 
                name: 'Anti Mention', 
                description: 'Limits excessive mentions',
                defaultLimit: 5,
                defaultPunishment: 'timeout',
                defaultTimeout: 5
            },
            antiBotAdd: { 
                icon: 'ü§ñ', 
                name: 'Anti Bot Add', 
                description: 'Blocks unauthorized bot additions',
                defaultLimit: 1,
                defaultPunishment: 'ban',
                defaultTimeout: 60
            },
            antiPrune: { 
                icon: 'üßπ', 
                name: 'Anti Prune', 
                description: 'Prevents mass member deletion',
                defaultLimit: 1,
                defaultPunishment: 'ban',
                defaultTimeout: 60
            },
            antiDangerousRolePermUpdate: { 
                icon: '‚ö†Ô∏è', 
                name: 'Anti Dangerous Role Perm Update', 
                description: 'Blocks dangerous permission additions',
                defaultLimit: 1,
                defaultPunishment: 'ban',
                defaultTimeout: 60
            },
            antiDangerousRoleAdd: { 
                icon: 'üö®', 
                name: 'Anti Dangerous Role Add', 
                description: 'Prevents dangerous role assignments',
                defaultLimit: 1,
                defaultPunishment: 'ban',
                defaultTimeout: 60
            },
            antiServerRename: { 
                icon: 'üè†', 
                name: 'Anti Server Rename', 
                description: 'Prevents unauthorized server renaming',
                defaultLimit: 1,
                defaultPunishment: 'ban',
                defaultTimeout: 30
            },
            antiVanityChange: { 
                icon: 'üîó', 
                name: 'Anti Vanity Change', 
                description: 'Blocks vanity URL changes',
                defaultLimit: 1,
                defaultPunishment: 'ban',
                defaultTimeout: 30
            },
            antiIconChange: { 
                icon: 'üñºÔ∏è', 
                name: 'Anti Icon Change', 
                description: 'Prevents server icon changes',
                defaultLimit: 1,
                defaultPunishment: 'ban',
                defaultTimeout: 30
            },
            antiChannelRename: { 
                icon: '‚úèÔ∏è', 
                name: 'Anti Channel Rename', 
                description: 'Blocks channel renaming',
                defaultLimit: 5,
                defaultPunishment: 'timeout',
                defaultTimeout: 15
            },
            antiRoleRename: { 
                icon: 'üé≠', 
                name: 'Anti Role Rename', 
                description: 'Prevents role renaming',
                defaultLimit: 5,
                defaultPunishment: 'timeout',
                defaultTimeout: 15
            },
            antiInviteLink: { 
                icon: 'üîó', 
                name: 'Anti Invite Link', 
                description: 'Removes unauthorized invite links',
                defaultLimit: 3,
                defaultPunishment: 'timeout',
                defaultTimeout: 5
            }
        };

        window.addEventListener('load', async () => {
            await loadUserData();
            await loadUserGuilds();
        });

        async function loadUserData() {
            try {
                const response = await fetch('/api/user');
                if (response.ok) {
                    const userData = await response.json();
                    document.getElementById('username').textContent = userData.username;
                    document.getElementById('user-id').textContent = `ID: ${userData.id}`;
                    
                    const avatarUrl = userData.avatar 
                        ? `https://cdn.discordapp.com/avatars/${userData.id}/${userData.avatar}.png`
                        : 'https://cdn.discordapp.com/embed/avatars/0.png';
                    document.getElementById('user-avatar').src = avatarUrl;
                } else if (response.status === 401) {
                    window.location.href = '/auth/discord';
                }
            } catch (error) {
                console.error('User loading error:', error);
            }
        }

        async function loadUserGuilds() {
            try {
                const response = await fetch('/api/user/guilds');
                if (response.ok) {
                    userGuilds = await response.json();
                    displayGuilds();
                } else if (response.status === 401) {
                    window.location.href = '/auth/discord';
                } else {
                    console.error('Non-OK response from server:', response.status);
                    document.getElementById('main-server-list').innerHTML = '<p>Error loading servers</p>';
                }
            } catch (error) {
                console.error('Server loading error:', error);
                document.getElementById('main-server-list').innerHTML = '<p>Error loading servers</p>';
            }
        }

        function displayGuilds() {
            const manageableServersCount = userGuilds.filter(g => g.userCanManage).length;
            document.getElementById('total-manageable-servers').textContent = manageableServersCount;

            const mainList = document.getElementById('main-server-list');
            mainList.innerHTML = userGuilds.map(guild => {
                let buttonHtml = '';
                let statusMessage = '';

                if (guild.userCanManage) {
                    if (guild.botInGuild) {
                        buttonHtml = `<button class="btn btn-success" onclick="showServerConfig('${guild.id}', '${guild.name.replace(/'/g, "\\'")}')">Configure</button>`;
                        statusMessage = guild.owner ? '<p style="color: #30BFFF;">üëë Owner</p>' : '<p style="color: #28a745;">‚úÖ Bot in server</p>';
                    } else {
                        const inviteLink = `https://discord.com/api/oauth2/authorize?client_id=${BOT_CLIENT_ID}&permissions=8&scope=bot%20applications.commands&guild_id=${guild.id}`;
                        buttonHtml = `<a href="${inviteLink}" target="_blank" class="btn btn-primary">Invite Bot</a>`;
                        statusMessage = '<p style="color: #dc3545;">Bot not in server</p>';
                    }
                } else {
                    buttonHtml = `<button class="btn" disabled style="opacity: 0.6; cursor: not-allowed;">No Permission</button>`;
                    statusMessage = '<p style="color: #f39c12;">No administrative permissions</p>';
                }

                return `
                    <div class="user-card">
                        <div>
                            <h3 class="server-name">${guild.name}</h3>
                            <p class="server-id">ID: ${guild.id}</p>
                            <div class="server-status">${statusMessage}</div>
                        </div>
                        ${buttonHtml}
                    </div>
                `;
            }).join('');
        }

        function generateProtectionItems() {
            const container = document.getElementById('protection-items');
            if (!container) {
                console.error('Protection-items container not found');
                return;
            }
            
            container.innerHTML = Object.keys(protectionConfigs).map(key => {
                const config = protectionConfigs[key];
                
                let settings;
                if (typeof guildSettings[key] === 'boolean') {
                    settings = {
                        enabled: guildSettings[key],
                        limit: config.defaultLimit,
                        punishmentType: config.defaultPunishment,
                        timeoutDuration: config.defaultTimeout
                    };
                } else {
                    settings = guildSettings[key] || {
                        enabled: false,
                        limit: config.defaultLimit,
                        punishmentType: config.defaultPunishment,
                        timeoutDuration: config.defaultTimeout
                    };
                }
                
                return `
                    <div class="protection-item">
                        <div class="protection-header">
                            <div>
                                <div class="protection-title">${config.icon} ${config.name}</div>
                                <p style="opacity: 0.8; margin-top: 8px;">${config.description}</p>
                            </div>
                            <div style="display: flex; align-items: center; gap: 20px;">
                                <button class="btn" onclick="toggleProtectionSettings('${key}')" style="padding: 10px 20px; font-size: 0.9em;">
                                    ‚öôÔ∏è Configure
                                </button>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="${key}" ${settings.enabled ? 'checked' : ''} onchange="toggleProtection('${key}', this)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="protection-settings" id="${key}-settings">
                            <div class="setting-input">
                                <label>Violation Limit</label>
                                <input type="number" id="${key}-limit" value="${settings.limit}" min="1" max="50" onchange="updateProtectionSetting('${key}', 'limit', this.value)">
                            </div>
                            <div class="setting-input">
                                <label>Punishment Type</label>
                                <select id="${key}-punishment" onchange="updateProtectionSetting('${key}', 'punishmentType', this.value)">
                                    <option value="kick" ${settings.punishmentType === 'kick' ? 'selected' : ''}>Kick</option>
                                    <option value="ban" ${settings.punishmentType === 'ban' ? 'selected' : ''}>Ban</option>
                                    <option value="timeout" ${settings.punishmentType === 'timeout' ? 'selected' : ''}>Timeout</option>
                                </select>
                            </div>
                            <div class="setting-input" id="${key}-timeout-setting" ${settings.punishmentType !== 'timeout' ? 'style="display: none;"' : ''}>
                                <label>Timeout Duration (minutes)</label>
                                <input type="number" id="${key}-timeout" value="${settings.timeoutDuration}" min="1" max="1440" onchange="updateProtectionSetting('${key}', 'timeoutDuration', this.value)">
                            </div>
                            <div style="margin-top: 20px;">
                                <button class="btn btn-success" onclick="saveProtectionSettings('${key}')" style="padding: 10px 20px; font-size: 0.9em;">
                                    üíæ Save Configuration
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleProtectionSettings(protectionKey) {
            const settings = document.getElementById(`${protectionKey}-settings`);
            settings.classList.toggle('active');
        }

        function toggleProtection(protectionKey, checkbox) {
            updateProtectionSetting(protectionKey, 'enabled', checkbox.checked);
        }

        function updateProtectionSetting(protectionKey, setting, value) {
            if (!guildSettings[protectionKey]) {
                guildSettings[protectionKey] = { ...protectionConfigs[protectionKey] };
            }
            
            if (setting === 'punishmentType') {
                const timeoutSetting = document.getElementById(`${protectionKey}-timeout-setting`);
                if (value === 'timeout') {
                    timeoutSetting.style.display = 'block';
                } else {
                    timeoutSetting.style.display = 'none';
                }
            }
            
            guildSettings[protectionKey][setting] = setting === 'enabled' ? value : 
                                                   setting === 'limit' || setting === 'timeoutDuration' ? parseInt(value) : 
                                                   value;
        }

        async function saveProtectionSettings(protectionKey) {
            if (!currentGuildId) {
                showNotification('No server selected', 'error');
                return;
            }
            
            const settings = guildSettings[protectionKey];
            if (!settings) {
                showNotification('No configuration to save', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/punishment-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        guildId: currentGuildId, 
                        setting: protectionKey,
                        config: settings
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Save error');
                }

                const result = await response.json();
                showNotification(`${protectionConfigs[protectionKey].name} configuration saved!`, 'success');
                await loadServerConfig(currentGuildId);
            } catch (error) {
                console.error('Protection save error:', error);
                showNotification('Error saving configuration', 'error');
            }
        }
        
        function showServerConfig(guildId, guildName) {
            currentGuildId = guildId;
            document.getElementById('server-list').style.display = 'none';
            document.getElementById('server-config').style.display = 'block';
            document.getElementById('section-navigation').classList.add('active');
            document.getElementById('current-server').textContent = guildName;
            document.getElementById('server-description').textContent = `Configure protections for ${guildName}`;
            loadServerConfig(guildId);
            loadGuildChannels(guildId);
            loadGuildRoles(guildId);
            showPermissionsSection();
        }
        
        function showServerList() {
            document.getElementById('server-list').style.display = 'block';
            document.getElementById('server-config').style.display = 'none';
            document.getElementById('section-navigation').classList.remove('active');
            currentGuildId = null;
        }

        function showPermissionsSection() {
            if (!currentGuildId) return;
            hideAllSections();
            document.getElementById('permissions-section').style.display = 'block';
            updateSectionNavigation('permissions');
        }

        function showVerificationSection() {
            if (!currentGuildId) return;
            hideAllSections();
            document.getElementById('verification-section').style.display = 'block';
            updateSectionNavigation('verification');
        }

        function showProtectionSection() {
            if (!currentGuildId) return;
            hideAllSections();
            document.getElementById('protection-section').style.display = 'block';
            updateSectionNavigation('protection');
        }

        function hideAllSections() {
            document.getElementById('permissions-section').style.display = 'none';
            document.getElementById('verification-section').style.display = 'none';
            document.getElementById('protection-section').style.display = 'none';
        }

        function updateSectionNavigation(activeSection) {
            document.querySelectorAll('.section-nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const sectionMap = {
                'permissions': 0,
                'verification': 1,
                'protection': 2
            };
            
            const buttons = document.querySelectorAll('.section-nav-button');
            if (buttons[sectionMap[activeSection]]) {
                buttons[sectionMap[activeSection]].classList.add('active');
            }
        }

        async function loadGuildChannels(guildId) {
            try {
                const response = await fetch(`/api/guild/${guildId}/channels`);
                if (response.ok) {
                    guildChannels = await response.json();
                    populateChannelSelects();
                }
            } catch (error) {
                console.error('Channel loading error:', error);
            }
        }

        async function loadGuildRoles(guildId) {
            try {
                const response = await fetch(`/api/guild/${guildId}/roles`);
                if (response.ok) {
                    guildRoles = await response.json();
                    populateRoleSelects();
                }
            } catch (error) {
                console.error('Role loading error:', error);
            }
        }

        function populateChannelSelects() {
            const channelSelects = ['verification-channel', 'banLog', 'roleLog', 'channelLog', 'securityLog', 'generalLog', 'messageLog', 'joinLeaveLog'];
            
            channelSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select a channel</option>';
                    guildChannels.forEach(channel => {
                        const option = document.createElement('option');
                        option.value = channel.id;
                        option.textContent = `# ${channel.name}`;
                        select.appendChild(option);
                    });
                    select.value = currentValue;
                }
            });
        }

        function populateRoleSelects() {
            const roleSelects = ['verification-role'];
            
            roleSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select a role</option>';
                    guildRoles.forEach(role => {
                        const option = document.createElement('option');
                        option.value = role.id;
                        option.textContent = `@ ${role.name}`;
                        option.style.color = role.color;
                        select.appendChild(option);
                    });
                    select.value = currentValue;
                }
            });
        }

        async function loadServerConfig(guildId) {
            try {
                const response = await fetch('/api/guild/' + guildId);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const config = await response.json();
                
                guildSettings = config.settings || {};
                generateProtectionItems();
                
                const logChannelIds = ['banLog', 'kickLog', 'roleLog', 'channelLog', 'securityLog', 'generalLog', 'messageLog', 'joinLeaveLog'];
                logChannelIds.forEach(logType => {
                    const select = document.getElementById(logType);
                    if (select && config.logChannels) {
                        select.value = config.logChannels[logType] || '';
                    }
                });
                
                const moderatorsList = document.getElementById('moderators-list');
                if (moderatorsList && config.moderators) {
                    moderatorsList.innerHTML = config.moderators.map(mod => `
                        <div class="user-card">
                            <span>ID: ${mod.userId}</span>
                            <button class="btn btn-danger" onclick="removeModerator('${mod.userId}')">Remove</button>
                        </div>
                    `).join('');
                }

                if (config.verification) {
                    const elements = {
                        'verification-enabled': config.verification.enabled,
                        'verification-channel': config.verification.channelId || '',
                        'verification-role': config.verification.roleId || '',
                        'verification-message': config.verification.message || '',
                        'captcha-enabled': config.verification.captchaEnabled,
                        'embed-color': config.verification.embedColor || '#30BFFF'
                    };
                    
                    Object.entries(elements).forEach(([id, value]) => {
                        const element = document.getElementById(id);
                        if (element) {
                            if (element.type === 'checkbox') {
                                element.checked = value;
                            } else {
                                element.value = value;
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Configuration loading error:', error);
                showNotification('Error loading server configuration', 'error');
            }
        }

        async function toggleVerification(element) {
            await saveVerification();
            if (element.checked) {
                showNotification('Verification enabled! Configure channels and roles, then send verification message.', 'info');
            }
        }
        
        async function addModerator() {
            const userId = document.getElementById('new-moderator-id').value;
            if (!userId || !currentGuildId) return;
            
            if (!/^\d{17,19}$/.test(userId)) {
                showNotification('Invalid user ID! Must be a 17-19 digit number', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/moderators', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ guildId: currentGuildId, userId })
                });

                if (!response.ok) {
                    throw new Error('Error adding moderator');
                }
                
                document.getElementById('new-moderator-id').value = '';
                loadServerConfig(currentGuildId);
                showNotification('Moderator added successfully!', 'success');
            } catch (error) {
                console.error('Moderator add error:', error);
                showNotification('Error adding moderator', 'error');
            }
        }
        
        async function removeModerator(userId) {
            if (!currentGuildId) return;
            
            if (!confirm('Are you sure you want to remove this moderator?')) return;
            
            try {
                const response = await fetch('/api/moderators', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ guildId: currentGuildId, userId })
                });

                if (!response.ok) {
                    throw new Error('Error removing moderator');
                }
                
                loadServerConfig(currentGuildId);
                showNotification('Moderator removed successfully!', 'success');
            } catch (error) {
                console.error('Moderator remove error:', error);
                showNotification('Error removing moderator', 'error');
            }
        }
        
        async function saveLogChannels() {
            if (!currentGuildId) return;
            
            const logChannels = {
                banLog: document.getElementById('banLog')?.value || '',
                kickLog: document.getElementById('kickLog')?.value || '',
                roleLog: document.getElementById('roleLog')?.value || '',
                channelLog: document.getElementById('channelLog')?.value || '',
                generalLog: document.getElementById('generalLog')?.value || '',
                securityLog: document.getElementById('securityLog')?.value || '',
                messageLog: document.getElementById('messageLog')?.value || '',
                joinLeaveLog: document.getElementById('joinLeaveLog')?.value || ''
            };
            
            try {
                const response = await fetch('/api/log-channels', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ guildId: currentGuildId, logChannels })
                });

                if (!response.ok) {
                    throw new Error('Error saving log channels');
                }
                
                showNotification('Log channels saved successfully!', 'success');
            } catch (error) {
                console.error('Log channels save error:', error);
                showNotification('Error saving log channels', 'error');
            }
        }
        
        async function saveVerification() {
            if (!currentGuildId) return;
            
            const verification = {
                enabled: document.getElementById('verification-enabled')?.checked || false,
                channelId: document.getElementById('verification-channel')?.value || '',
                roleId: document.getElementById('verification-role')?.value || '',
                message: document.getElementById('verification-message')?.value || 'Click the button to verify!',
                captchaEnabled: document.getElementById('captcha-enabled')?.checked || false,
                embedColor: document.getElementById('embed-color')?.value || '#30BFFF'
            };
            
            try {
                const response = await fetch('/api/verification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ guildId: currentGuildId, verification })
                });

                if (!response.ok) {
                    throw new Error('Error saving verification');
                }
                
                if (verification.enabled && verification.channelId && verification.roleId) {
                    await sendVerificationMessage();
                }
                
                showNotification('Verification configuration saved successfully!', 'success');
            } catch (error) {
                console.error('Verification save error:', error);
                showNotification('Error saving verification', 'error');
            }
        }

        async function sendVerificationMessage() {
            if (!currentGuildId) {
                showNotification('Select a server before sending verification message.', 'error');
                return;
            }

            const verificationEnabled = document.getElementById('verification-enabled')?.checked;
            const verificationChannelId = document.getElementById('verification-channel')?.value;
            const verificationRoleId = document.getElementById('verification-role')?.value;

            if (!verificationEnabled) {
                showNotification('Enable verification system before sending message.', 'error');
                return;
            }
            if (!verificationChannelId) {
                showNotification('Select a verification channel.', 'error');
                return;
            }
            if (!verificationRoleId) {
                showNotification('Select a verification role.', 'error');
                return;
            }
            
            showNotification('Sending verification message...', 'info');

            try {
                const response = await fetch('/api/send-verification-message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ guildId: currentGuildId })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Unknown error during message sending.');
                }
                
                showNotification('Verification message sent automatically successfully!', 'success');
            } catch (error) {
                console.error('Verification message send error:', error);
                showNotification(`Verification message send error: ${error.message}`, 'error');
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 5000);
        }

        window.addEventListener('error', (e) => {
            console.error('JavaScript error:', e.error);
            showNotification(`Error: ${e.message || 'An unexpected error occurred.'}`, 'error');
        });

        window.addEventListener('online', () => {
            showNotification('Connection restored', 'success');
        });

        window.addEventListener('offline', () => {
            showNotification('Connection lost', 'error');
        });
    </script>
</body>
</html>
